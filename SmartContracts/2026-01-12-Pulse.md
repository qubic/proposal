# Pulse

## Available Options
> Option 0: no, dont allow

> Option 1: yes, allow

## Table of Contents
1. [Introduction](#1-introduction)
2. [Game Mechanics](#2-game-mechanics)
3. [Auto Participation](#3-auto-participation)
4. [Revenue Distribution](#4-revenue-distribution)
5. [Prize Structure](#5-prize-structure)
6. [Settlement Process](#6-settlement-process)
7. [Admin Controls and Configuration](#7-admin-controls-and-configuration)
8. [Code](#8-code)

---

## 1. Introduction

Pulse is a 6-digit lottery smart contract on Qubic. Each ticket holds six digits
in the range [0, 9]. Winning digits are also six draws from [0, 9], with
duplicates allowed. Payouts use fixed reward tables with a pro-rata fallback
when contract balance is insufficient. The contract enforces a QHeart balance
cap and sweeps excess to the QHeart issuer wallet.

### Key Features

- Fixed prize tables (left-aligned and any-position) with best-of selection
- Scheduled draws (Wednesday always; plus schedule bitmask, default Wed/Fri/Sun at 11:00 UTC)
- Configurable fee split (dev, burn, PULSE shareholders, Random Lottery shareholders, QHeart wallet)
- Pro-rata payouts under insufficient balance
- Auto-participation deposits and auto-purchasing
- QHeart balance cap with excess sweep

---

## 2. Game Mechanics

### Number Selection

- Ticket digits are six values in [0, 9].
- Duplicate digits are allowed.
- Any digit outside [0, 9] is rejected.

### Ticket Purchase

#### BuyTicket
1. Fails if selling is closed.
2. Validates digits are within range.
3. Fails if the round ticket cap (1,024) is reached.
4. Fails if the player does not have sufficient QHeart.
5. Transfers ticket price to the contract and records the ticket.

#### BuyRandomTickets
1. Fails if count is zero.
2. Fails if selling is closed.
3. Clamps purchase count to the remaining slots.
4. Fails if no slots remain.
5. Charges the player for the clamped count.
6. Allocates random digits for each ticket.

### Winning Criteria

For each ticket, the prize is the maximum of:
- **Left-aligned matches**: number of consecutive matches from index 0 until the first mismatch.
- **Any-position matches**: sum over digits of `min(ticketCount[d], winningCount[d])`.

Duplicates count toward matches based on multiplicity.

---

## 3. Auto Participation

### Overview

Users can deposit QHeart for automatic purchases. Each auto entry stores:
- `deposit` (QHeart reserved in the contract wallet)
- `desiredTickets` (number of tickets to buy per auto run)

The contract maintains a registry capped at 512 entries
(half of the ticket capacity).

### DepositAutoParticipation

- Rejects if registry is full (including attempts to top up an existing entry).
- Rejects if `amount <= 0` or `desiredTickets <= 0`.
- Clamps `desiredTickets` to `maxAutoTicketsPerUser` when non-zero.
- Clamps `amount` to available user balance.
- Requires `amount >= ticketPrice * desiredTickets`.
- If `buyNow` and selling is open, buys up to `desiredTickets` via `BuyRandomTickets` (clamped by remaining slots).
- After the buy, the requested `amount` is reduced by `ticketPrice * desiredTickets`.
- If the remainder is `<= 0`, no entry is created.
- Otherwise, the remainder is transferred to the contract and stored/updated.
- If `buyNow` is false or selling is closed, the full `amount` is transferred and stored/updated.

### WithdrawAutoParticipation

- Rejects if no entry exists.
- If `amount <= 0`, withdraws the full deposit.
- Otherwise withdraws `min(amount, deposit)`.
- Removes entry if deposit becomes zero.

### SetAutoConfig

- `desiredTickets < -1` is treated as `-1`.
- `desiredTickets == -1` keeps the existing value.
- `desiredTickets == 0` is invalid.
- `desiredTickets > 0` sets a new value.

### SetAutoLimits

- Owner-only. Sets `maxAutoTicketsPerUser` immediately.
- `0` disables the per-user limit.
- Values above the ticket cap are clamped to 1,024.
- Existing entries are updated to comply with the new limit.

### Auto Purchase Timing

Auto purchases can run:
- At `BEGIN_EPOCH` when selling is open (and not at the bootstrap sentinel).
- At `BEGIN_TICK` on the first valid day after bootstrap to seed selling.
- At `BEGIN_TICK` after a non-Wednesday draw when selling reopens.

Auto purchases are skipped when selling is closed or no slots remain.
Unaffordable entries are removed.
After Wednesday draws, selling remains closed until the next epoch begins.

---

## 4. Revenue Distribution

Ticket revenue is split by configured percentages:
- Dev
- Burn
- PULSE shareholders
- Random Lottery (QTF) shareholders
- QHeart wallet
- Remainder retained in the contract for prizes

**Defaults:**
- Dev: 10%
- Burn: 5%
- PULSE shareholders: 8%
- Random Lottery shareholders: 2%
- QHeart wallet: 5%

The sum of percentages (including Random Lottery shareholders) must be <= 100.

Shareholder rewards are distributed pro-rata to holders of the `PULSE` asset and the Random Lottery asset.

---

## 5. Prize Structure

### Left-Aligned Reward Table

| Matches | Reward |
|---------|--------|
| 6 | 2000 x ticket price |
| 5 | 300 x ticket price |
| 4 | 60 x ticket price |
| 3 | 20 x ticket price |
| 2 | 4 x ticket price |
| 1 | 1 x ticket price |
| 0 | 0 |

### Any-Position Reward Table

| Matches | Reward |
|---------|--------|
| 6 | 150 x ticket price |
| 5 | 30 x ticket price |
| 4 | 8 x ticket price |
| 3 | 2 x ticket price |
| 2 | 0 |
| 1 | 0 |
| 0 | 0 |

### Payout Rule

For each ticket:
```
prize = max(leftAlignedReward, anyPositionReward)
```

If the contract balance is insufficient to pay all prizes:
```
scaledPrize = floor(prize * availableBalance / totalPrize)
```

---

## 6. Settlement Process

Settlement is triggered during `BEGIN_TICK` when:
1. Current hour >= draw hour
2. Day is Wednesday, or matches the configured schedule bitmask
3. The date differs from the last draw date

Draw checks are throttled to every 100 ticks.

### Settlement Steps

1. If no tickets sold, return.
2. Compute round revenue: `ticketPrice * ticketCounter`.
3. Transfer fees (dev, burn, PULSE shareholders, Random Lottery shareholders, QHeart wallet).
4. Generate six winning digits from the previous spectrum digest.
5. Compute total prize across all tickets.
6. Pay prizes (full or pro-rata).
7. Update winners ring buffer.
8. Sweep excess balance above `qheartHoldLimit` to the QHeart wallet.
9. Clear tickets and close the round.
10. Reopen selling after non-Wednesday draws and run auto-purchases.

---

## 7. Admin Controls and Configuration

Owner-only procedures use the QHeart issuer as the admin address.
Unless noted, changes are scheduled and applied at `END_EPOCH`:

- `SetPrice(newPrice)` (must be > 0)
- `SetSchedule(newSchedule)` (bitmask, must be non-zero)
- `SetDrawHour(newDrawHour)` (0-23)
- `SetFees(dev, burn, shareholders, rlShareholders, qheart)` (sum <= 100)
- `SetQHeartHoldLimit(newLimit)`
- `SetAutoLimits(maxTicketsPerUser)` (applies immediately)

At `BEGIN_EPOCH`, if the schedule or draw hour is `0`, it resets to the defaults.

Default configuration:
- Ticket price: 200,000 QHeart
- Draw hour: 11:00 UTC
- Schedule: Wednesday, Friday, Sunday
- Hold limit: 2,000,000,000 QHeart
- Auto limit: 512 tickets per user
- Fees: 10% dev, 5% burn, 8% PULSE shareholders, 2% Random Lottery shareholders, 5% QHeart wallet
---

## 8. Code

[PR](https://github.com/qubic/core/pull/714)

---
